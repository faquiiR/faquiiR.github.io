<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="很多事还没做">
<meta property="og:url" content="http://ccxhuy.cn/index.html">
<meta property="og:site_name" content="很多事还没做">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="很多事还没做">
<meta name="twitter:description">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://ccxhuy.cn/"/>


  <title> 很多事还没做 </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">很多事还没做</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/14/test/" itemprop="url">
                  test
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-06-14T23:04:52+08:00" content="2016-06-14">
              2016-06-14
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="aaaa"><a href="#aaaa" class="headerlink" title="aaaa"></a>aaaa</h3>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/27/php生命周期和内核/" itemprop="url">
                  php生命周期和内核
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-05-27T15:00:13+08:00" content="2016-05-27">
              2016-05-27
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/PHP/" itemprop="url" rel="index">
                    <span itemprop="name">PHP</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="关注PHP内核实现的原因"><a href="#关注PHP内核实现的原因" class="headerlink" title="关注PHP内核实现的原因"></a>关注PHP内核实现的原因</h3><p>c是启蒙,java是第一份工作入行的语言,工作期间主要用php,纯php写过游戏代码,laravel写过web和api.更喜欢的语言是go,更欣赏的语言(工具)是openresty.<br>吃饭的技术还是要花更多的时间去深入了解,起码对自己来说够用,可以解决绝大部分的问题,可以支撑自己的技术体系.每次读相关的资料都会比上一次有更深刻的了解,<br>知识面越广,深度越深,之前的疑问也都豁然开朗了,同时有更多的疑问和困扰,这也许正应了那句话:刚毕业的时候觉得自己什么都会,工作一阵觉得自己会几门技术,再久了<br>觉得自己什么都不会了.广度和深度的问题,我选择一专多长这种模式,做到比更多的人更了解php的知识体系,学好自己喜欢的go和resty.</p>
<h3 id="个人php方向的技能树"><a href="#个人php方向的技能树" class="headerlink" title="个人php方向的技能树"></a>个人php方向的技能树</h3><blockquote>
<ul>
<li>php手册的大部分知识点</li>
<li>laravel框架源码</li>
<li>phalcon框架和zephir语法</li>
<li>php生命周期和部分源码</li>
<li>c扩展开发或者zephir扩展开发</li>
<li>ps*规范</li>
<li>composer和packagelist</li>
<li>swoole</li>
</ul>
</blockquote>
<h3 id="php方面的资料"><a href="#php方面的资料" class="headerlink" title="php方面的资料"></a>php方面的资料</h3><blockquote>
<ul>
<li>php manual</li>
<li>php the right way</li>
<li>php核心技术与最佳时间</li>
<li>walu.cc (扩展开发)</li>
<li><a href="http://www.laruence.com" target="_blank" rel="external">http://www.laruence.com</a> (鸟哥博客,某些知识点的深入介绍)</li>
<li>thinking in php internals</li>
<li><a href="http://zephir-lang.com.cn" target="_blank" rel="external">http://zephir-lang.com.cn</a> 扩展开发</li>
<li>lxr.php.net 查看源码不要太爽~</li>
</ul>
</blockquote>
<h3 id="fastcgi模式php生命周期粗略分析"><a href="#fastcgi模式php生命周期粗略分析" class="headerlink" title="fastcgi模式php生命周期粗略分析"></a>fastcgi模式php生命周期粗略分析</h3><h4 id="sapi-fastcgi是主要用的一种-启动和初始化"><a href="#sapi-fastcgi是主要用的一种-启动和初始化" class="headerlink" title="sapi(fastcgi是主要用的一种)启动和初始化"></a>sapi(fastcgi是主要用的一种)启动和初始化</h4><p>fastcgi进程管理器初始化,初始化多个常驻内存的cgi进程解释器.socket端口绑定之后进入accept状态等待nginx请求到来,fcgi_accept_request函数会判断是否处理用户的请求，其中会过滤某些连接请求，忽略受限制客户的请求， 如果程序受理用户的请求，它将分析请求的信息，将相关的变量写到对应的变量中。 其中在读取请求内容时调用了safe_read方法。如下所示： [main() -&gt; fcgi_accept_request() -&gt; fcgi_read_request() -&gt; safe_read()]<br>sapi启动的时候,调用php_module_startup方法,初始化一些变量和常量,如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">zuf.error_function = php_error_cb;</span><br><span class="line">zuf.printf_function = php_printf;</span><br><span class="line">zuf.write_function = php_output_wrapper;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>以及PHP_VERSION等常量的初始化.之前还有初始化输出的hash结构等.<br>然后是初始化zend引擎和php的核心组件.初始化其实就是函数赋值.这部分的入口在zend_startup,主要工作有内存管理初始化,初始化一些hashtable,比如函数表,常量表,变量表,类表等(本身内存管理就是引擎要做的事情),词法分析scanner,语法分析parser,<br>opcode代码执行的executor的函数指针在zend模块相应文件中的函数赋值,ini文件解析的函数指针初始化,注册内置函数到函数表如strlen等,注册E_ALL,true等常量到常量表,注册$GLOBALS变量,和其他很多的准备工作.<br>然后是解析ini文件赋值到的php_core_globals,也就是PG(v)系列.还有一些初始化工作包括$_GET,$_POST等预定义变量的初始化(空的hash),根据不同的sapi初始化read_post的函数,cli和cgi当然是不同的函数,cli应该是空的函数.<br>再然后是比较直观的初始化过程,加载静态编译构建的扩展模块的MINIT方法(dl()加载的扩展不算).<br>根据ini文件的配置分别调用zend_disable_function和zend_disable_class从CG(function_table)和CG(class_table)移除已加载的函数和类.</p>
<h4 id="web服务器-nginx-和fastcgi进行socket通信-按cgi协议发送cgi环境变量和标准输入stdin给cgi进程"><a href="#web服务器-nginx-和fastcgi进行socket通信-按cgi协议发送cgi环境变量和标准输入stdin给cgi进程" class="headerlink" title="web服务器(nginx)和fastcgi进行socket通信,按cgi协议发送cgi环境变量和标准输入stdin给cgi进程"></a>web服务器(nginx)和fastcgi进行socket通信,按cgi协议发送cgi环境变量和标准输入stdin给cgi进程</h4><p>请求到达sapi并且sapi初始化之后,进入请求处理的过程,在php_request_startup进行请求初始化的操作.里面的核心代码是sapi_activate,<br>即sapi的激活过程.init_compiler和init_executor分别初始化编译器和opcode的执行代码,sapi启动过程只是简单的函数指针赋值,这个地方会进行初始化操作,比如给opcode_array的清空操作,<br>EG(function_table) = CG(function_table)等类似的赋值操作,代码执行期间的函数和变量都是从EG()获取,CG()是内置函数,变量和类的初始化数据结构,EG()会把内置的复制过来然后解析过程加入用户自定义的相关变量.</p>
<p>激活sapi的sapi_activate函数内一眼看去全是request,header,post,cookie等单词,也就是针对请求的各种变量的初始化,环境变量相关的宏是SG(),post,cookie等数据的读取函数的初始化,$_POST、$_GET、$_COOKIE、$_SERVER、$_ENV、$_FILES<br>也会根据fcgi从nginx的socket请求读取的原始数据进行格式处理之后解析到的值进行初始化.<br>最后是zend_activate_modules调用各个扩展模块的RINIT函数.</p>
<h4 id="cgi进程解析器进行处理并将标准输出stdout和错误输出stderr返回给nginx"><a href="#cgi进程解析器进行处理并将标准输出stdout和错误输出stderr返回给nginx" class="headerlink" title="cgi进程解析器进行处理并将标准输出stdout和错误输出stderr返回给nginx"></a>cgi进程解析器进行处理并将标准输出stdout和错误输出stderr返回给nginx</h4><p>这个过程是cgi进程根据环境变量和标准输入找到对应的php脚本进行解释执行.php_execute_script函数包含了运行PHP脚本的全部过程.<br>这个过程主要是zend引擎和php核心的工作.词法分析,语法分析,语义分析,去掉空格注释,用re2c工具将php源码解析为一个个的token并填充到指定格式的解析树.然后是语法语义分析将token对应为<br>zend虚拟机自己的opcode指令,比如ZEND_ECHO等,zend指令对应的是php核心的c函数,所有脚本的代码解析完opcode会存入opcode array结构体,结构体内部维护了一个数组,executor的执行类似<br>while(1) do,从array取出opcode然后用CALL或者GOTO等方式调用对应的c函数,函数,类和变量等存在之前过程初始化赋值的EG(),代码执行完毕输出结果通过当前socket连接的fd回传给nginx</p>
<h4 id="cgi解析器结束当前socket连接-并等待下一个连接"><a href="#cgi解析器结束当前socket连接-并等待下一个连接" class="headerlink" title="cgi解析器结束当前socket连接,并等待下一个连接"></a>cgi解析器结束当前socket连接,并等待下一个连接</h4><p>php_request_shutdown进行一次请求结束之后的关闭操作.register_shutdown_function注册的函数会执行,EG(objects_store）中对象的_destruct方法执行,<br>flush输出缓存中的数据,按照http协议在socket中发送标准的http头,执行各个扩展的RSHUTDOWN,SG(sapi_headers)、SG(request_info)中的内容清空,关闭各种流文件,<br>总之就是各种关闭清空操作.</p>
<h3 id="先搭一个架子-后续纠正或者补充-争取自己看的时候可以比较清晰理解-现在写的很乱"><a href="#先搭一个架子-后续纠正或者补充-争取自己看的时候可以比较清晰理解-现在写的很乱" class="headerlink" title="先搭一个架子,后续纠正或者补充,争取自己看的时候可以比较清晰理解.现在写的很乱."></a>先搭一个架子,后续纠正或者补充,争取自己看的时候可以比较清晰理解.现在写的很乱.</h3>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/23/Vagrant开发环境部署/" itemprop="url">
                  Vagrant开发环境部署
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-05-23T17:48:22+08:00" content="2016-05-23">
              2016-05-23
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index">
                    <span itemprop="name">Tools</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="文件清单"><a href="#文件清单" class="headerlink" title="文件清单"></a>文件清单</h3><ul>
<li>Git-2.7.2.exe 主要是用git bash</li>
<li>vagrant_1.8.1.dmg mac vagrant安装包</li>
<li>vagrant_1.8.1.msi windows vagrant安装包</li>
<li>VirtualBox-5.0.18-xxx.dmg mac vbox安装包</li>
<li>VirtualBox-5.0.18-xxx.exe windows vbox安装包</li>
<li>zerogo-dev.box 打包好的镜像文件</li>
</ul>
<h3 id="zerogo-dev-box已安装列表"><a href="#zerogo-dev-box已安装列表" class="headerlink" title="zerogo-dev.box已安装列表"></a>zerogo-dev.box已安装列表</h3><ol>
<li>php5.6</li>
<li>nginx 1.8</li>
<li>mysql</li>
<li>postgresql</li>
<li>redis</li>
<li>node</li>
<li>npm</li>
<li>apidoc</li>
<li>hhvm facebook的php解析器，功能和php-fpm + php类似</li>
<li>php-fpm<h2 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h2></li>
<li>安装VirtualBox</li>
<li>安装vagrant</li>
<li>拷贝zerogo-dev.box 磁盘某处</li>
<li>进入zerogo-dev.box所在目录</li>
<li>在git bash里执行 vagrant box add zerogo zerogo-dev.box</li>
<li>vagrant box list 如果添加成功会显示zerogo(virtualbox,0)</li>
<li>可以在D盘新建目录Code，进入目录bash执行 vagrant init</li>
<li>用sublime等编辑上一步生成的Vagrantfile</li>
</ol>
<h3 id="修改或者打开注释，必须的几项："><a href="#修改或者打开注释，必须的几项：" class="headerlink" title="修改或者打开注释，必须的几项："></a>修改或者打开注释，必须的几项：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">config.vm.box = &quot;zerogo&quot; # 和add时候名字一样</span><br><span class="line">config.vm.box_check_update = false # 不检查更新，不能更新~</span><br><span class="line">config.vm.network &quot;forwarded_port&quot;, guest: 80, host: 8080</span><br><span class="line">config.vm.network &quot;private_network&quot;, ip: &quot;192.168.33.10&quot;</span><br><span class="line">config.vm.synced_folder &quot;/Users/huy/Code&quot;, &quot;/vagrant_data&quot; # windows改成相应的路径 可以用.表示当前D:/Code目录</span><br></pre></td></tr></table></figure>
<p>在本地浏览器用127.0.0.1:8080和192.168.33.10都可以访问虚拟机的nginx 80端口，数据库可以用192.168.33.10:3306访问，也可以在本地配置端口映射，和80类似。<br>nginx的conf.d有一个默认配置，把路径修改为自己的。<br>apidoc所需的环境已装好，可以直接执行项目里的apidoc.sh.</p>
<h3 id="vagrant常用命令"><a href="#vagrant常用命令" class="headerlink" title="vagrant常用命令"></a>vagrant常用命令</h3><ul>
<li>vagrant up 打开虚拟机</li>
<li>vagrant ssh 进入虚拟机</li>
<li>vagrant halt 关机</li>
<li>vagrant suspend 休眠，开机之后如果关主机，先执行这个休眠掉</li>
<li>vagrant resume 休眠恢复，用vagrant up也可以</li>
<li>vagrant destroy 干掉虚拟机</li>
</ul>
<p>正常的操作步骤是<code>vagrant up</code>开机，在bash用<code>vagrant ssh</code> 进入，如果要退出或关机先<code>ctr + d</code>,然后<code>vagrant suspend</code>或者<code>vagrant halt</code>休眠或关机，再用时，<code>vagrant resume</code>或者<code>vagrant up</code>。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/23/laravel5-1源码分析（上）/" itemprop="url">
                  laravel5.1源码分析（上）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-05-23T17:45:41+08:00" content="2016-05-23">
              2016-05-23
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Laravel/" itemprop="url" rel="index">
                    <span itemprop="name">Laravel</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="1-类加载机制"><a href="#1-类加载机制" class="headerlink" title="1.类加载机制"></a>1.类加载机制</h3><p>从框架入口文件/public/index.php分析<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span>.<span class="string">'/../bootstrap/autoload.php'</span>;</span><br></pre></td></tr></table></figure></p>
<p>查看/bootstrap/autoload.php(此bootstrap是<code>引导程序</code>的意思，和Twitter的前端框架无关)<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span>.<span class="string">'/../vendor/autoload.php'</span>;</span><br></pre></td></tr></table></figure></p>
<p>引导程序主要目的是加载框架核心的<code>autoload.php</code><br>查看/vendor/autoload.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require_once</span> <span class="keyword">__DIR__</span> . <span class="string">'/composer'</span> . <span class="string">'/autoload_real.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ComposerAutoloaderInite076afe45cb086ab2da8c82077e278c9::getLoader();</span><br></pre></td></tr></table></figure></p>
<p>可见框架的类加载机制的核心就是上述两行代码。查看/vendor/composer/autoload_real.php，定义了类<code>ComposerAutoloaderInite076afe45cb086ab2da8c82077e278c9</code>和方法<code>loadClassLoader</code>和<br><code>getLoader</code>，看composer目录下的文件主要有：</p>
<blockquote>
<p>autoload_classmap.php<br>autoload_files.php<br>autoload_namespaces.php<br>ClassLoader.php</p>
</blockquote>
<p><code>ClassLoader</code>类主要是定义框架的各种规范的类加载方法，以psr4标准的加载机制举例，在<code>autoload_real.php</code>中，实例化<code>ClassLoader</code>执行如下代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$map = <span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/autoload_psr4.php'</span>;</span><br><span class="line">        <span class="keyword">foreach</span> ($map <span class="keyword">as</span> $namespace =&gt; $path) &#123;</span><br><span class="line">            $loader-&gt;setPsr4($namespace, $path);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></p>
<p><code>autoload_psr4.php</code>返回一个数组<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">...</span><br><span class="line"><span class="string">'Carbon\\'</span> =&gt; <span class="keyword">array</span>($vendorDir . <span class="string">'/nesbot/carbon/src/Carbon'</span>),</span><br><span class="line"><span class="string">'App\\'</span> =&gt; <span class="keyword">array</span>($baseDir . <span class="string">'/app'</span>),</span><br><span class="line">)</span><br></pre></td></tr></table></figure></p>
<p>可以看到第三方类库<code>Carbon</code>对应的目录在vendor下，而项目的根命名空间对应的目录/app，从/public/index.php到这里几乎全是<code>require</code>加载的代码，所以执行到业务代码之前类加载机制已经处理完，框架核心和我们写的<code>App</code>命名空间下的代码都可以被框架加载。</p>
<p>类加载机制的核心是<code>spl_autoload_register</code>函数，主要思想其实很简单，就是给定一个类名，调用一个回调函数找到项目里的这个php文件，<code>include</code>进来。laravel比较庞大所以加载机制多一些，我们只关心关于psr4标准的加载机制即可。</p>
<blockquote>
<p>psr4标准，具体可以参考www.php-fig.org,简而言之就是我们只需要限定跟命名空间和根目录的映射关系，比如<code>App\\</code>对应的是<code>/app</code>，那么<code>App\Http\Controllers\UserController</code>默认的文件路径必须在<code>/app/Http/Controllers/UserController.php</code>，符合这个标准的我们只需要简单实现spl_autoload_register即可实现类自动加载。</p>
</blockquote>
<h3 id="2-框架核心Application对象"><a href="#2-框架核心Application对象" class="headerlink" title="2.框架核心Application对象"></a>2.框架核心Application对象</h3><p>回到/public/index.php，<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span>.<span class="string">'/../bootstrap/autoload.php'</span>;</span><br><span class="line">$app = <span class="keyword">require_once</span> <span class="keyword">__DIR__</span>.<span class="string">'/../bootstrap/app.php'</span>;</span><br></pre></td></tr></table></figure></p>
<p>第一行做的事是上面分析的关于类自动加载的机制，然后就是加载<br>/bootstrap/app.php实例化框架的核心类Application。<br>构造方法如下：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($basePath = null)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;registerBaseBindings();  <span class="comment">//往容器注册名称为app的对象，是当前对象本身（继承关系）</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;registerBaseServiceProviders();<span class="comment">//注册所有地方都必须的基础ServiceProvider 事件和路由</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;registerCoreContainerAliases(); <span class="comment">//别名配置，用一个简短的命名映射一个带命名空间的类</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($basePath) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setBasePath($basePath);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>$basePath</code>在/bootstrap/app.php传入的是/bootstrap的上级目录，也就是项目目录。</p>
<p>Application类继承Container类，Container相当于框架的对象容器，设计理念就是IOC（控制反转），意味着在框架里使用容器托管的对象不需要在相应的类进行硬编码，用到哪个类直接从容器取，如果需要调整我们修改注册到容器的类即可，这样两个类直接实现解耦。laravel这部分的概念通过容器，ioc和Facade设计模式实现。</p>
<h3 id="Application的一些关键属性和方法（包块继承自Container的）"><a href="#Application的一些关键属性和方法（包块继承自Container的）" class="headerlink" title="Application的一些关键属性和方法（包块继承自Container的）"></a>Application的一些关键属性和方法（包块继承自Container的）</h3><blockquote>
<ul>
<li><p>$instance，用于单例模式的静态属性，容器类必然需要单例</p>
</li>
<li><p>$instances (array) 保存共享的对象也就是单例对象</p>
</li>
<li><p>bindings (array)绑定，数据结构大概如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">'A\B\UserController'</span> =&gt;</span><br><span class="line">    [<span class="string">'concreate'</span> =&gt; \$obj ], <span class="comment">//单例时是闭包函数返回实例，否则只是类名</span></span><br><span class="line">    [<span class="string">'shared'</span> =&gt; <span class="keyword">true</span> ]</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>\$alias (array) 别名数组</p>
</li>
<li>bind() 往bindings数组填充数据，默认是非单例模式</li>
<li>singleton() 调用的bind()传入一个\$shared = true 表示是共享实例，这样会往\$instances数组存入一个对象。</li>
<li>make() 比如\$app<code>-&gt;make(&#39;redis&#39;)</code>,通过Application的构造函数中调用的alias相关的函数，发现<code>redis</code>是<code>Illuminate\Contracts\Redis\Database</code>的别名，然后在$instance查找是否存在，存在直接返回，不存在的话去\$binds查找绑定关系，找到对应的对应的完整类名，然后通过反射机制找到这个类的构造返回生成实例返回。（大多数情况理解到这里够用了，里面有很多判断比如别名和绑定的倒腾，还要容器的扩展等等，理解核心的机制即可）.</li>
</ul>
</blockquote>
<p>到这里容器对象初始化完成。<br>回到/public/index.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$kernel = $app-&gt;make(Illuminate\Contracts\Http\Kernel::class);</span><br><span class="line"></span><br><span class="line">$response = $kernel-&gt;handle(</span><br><span class="line">    $request = Illuminate\Http\Request::capture()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$response-&gt;send();</span><br><span class="line"></span><br><span class="line">$kernel-&gt;terminate($request, $response);</span><br></pre></td></tr></table></figure></p>
<p>这部分是初始化处理http请求的Kernel对象，大致是先处理request对象收集的请求信息，包括get、post、ip、uri、headers等数据，然后根据路由文件配置的get、post等请求的uri和控制器及方法映射，进行dispatch分发，初始化对象执行方法，返回一个带有数据（view渲染的试图或者json数据），调用send()方法按照http协议格式化输出内容flush给客户端。这部分下一次单独讲。</p>
<h3 id="Facade设计模式"><a href="#Facade设计模式" class="headerlink" title="Facade设计模式"></a>Facade设计模式</h3><p>设计模式大多都有重叠的地方，比如数据库设计师典型的工厂模式，默认配置是mysql那么DB系列的方法初始化的是MysqlConnector等，Facade模式的中文翻译是“门面模式”，简单理解为给程序员直接调用的类只是一个门面或者代理，真正的逻辑是在背后映射的那个真实的类来实现。和只有一种模式的工厂模式以及代理模式类似。好处是程序员不需要修改代码，通过修改门面背后的类来换一套实现逻辑。缺点是搞得代码无法快速跟踪，反正我不觉得这种设计模式很好。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/23/laravel5-1事件机制使用/" itemprop="url">
                  laravel5.1事件机制使用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-05-23T17:42:07+08:00" content="2016-05-23">
              2016-05-23
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Laravel/" itemprop="url" rel="index">
                    <span itemprop="name">Laravel</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="事件和队列的区别及关联"><a href="#事件和队列的区别及关联" class="headerlink" title="事件和队列的区别及关联"></a>事件和队列的区别及关联</h3><blockquote>
<p><code>事件</code> 侧重主动触发一个行为，比如注册接口我们可以收集用户数据然后触发一个登录事件，这个事件可以有多个监听器，每个监听器都可以拿到事件的数据进行处理。这是一个典型的观察者模式。</p>
<p><code>队列</code> 侧重把想做的比较耗时的业务放在一个容器然后另一个程序一直消费，当然可以是同步处理也可以异步处理。和事件的区别是，事件侧重只抛出一个事件（核心是数据）剩下的交给观察者们，队列是把想做的几件事都放到队列。队列是典型的生产者消费者模式，常见的有自定义队列，redis队列和kakfa。</p>
</blockquote>
<p>注册、充值和购买等核心业务接口，通常要做很多运营相关的处理，最差的方式是硬编码，队列稍好，可以把业务转移到消费者，但是比如注册，要送红包，要处理师徒相关的等等，队列需要在controller中dispatch好几次，这种场景事件更干净一点。register接口处理完业务，抛出一个UserRegEvent，这种对象可以有一个User类的属性存放数据库取出的model，然后定义RedPacketListener和TuiguangListener，这两个监听器拿到user model有充足的数据做自己要做的逻辑。以后停掉红包我们就注释掉数组中一行数据即可，新运营活动增加一个listener即可。</p>
<h3 id="la5-1使用队列"><a href="#la5-1使用队列" class="headerlink" title="la5.1使用队列"></a>la5.1使用队列</h3><p>队列默认(驱动默认是sync)是同步的，也就是几个listener的逻辑会同步执行完才返回。事件支持队列模式，需要listener <code>implement ShouldQueue</code>，然后配置队列相关的信息，如果是用database驱动，需要在默认连接的数据库新建jobs表，这部分和队列是一样的,一般驱动选redis，在config/queue.php配置中驱动选redis，config/database.php配置队列所用的redis连接，这两种方式都已经测试通过。<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan queue:table</span><br></pre></td></tr></table></figure></p>
<p>生成jobs表的迁移文件，然后<code>php artisan migrate</code>会自动在默认库建立该表。</p>
<h4 id="自动生成事件和监听器"><a href="#自动生成事件和监听器" class="headerlink" title="自动生成事件和监听器"></a>自动生成事件和监听器</h4><p>在app/Providers/EventServiceProvider.php中<code>$listen</code>数组配置如下信息：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> $listen = [</span><br><span class="line">  <span class="string">'App\Events\UserRegEvent'</span> =&gt; [</span><br><span class="line">    <span class="string">'App\Listeners\SendPrizeListener'</span>,</span><br><span class="line">    <span class="string">'App\Listeners\SaveLogListener'</span></span><br><span class="line">  ],</span><br><span class="line">];</span><br></pre></td></tr></table></figure></p>
<p>配置了一个UserRegEvent，和它对应的两个listener，然后执行<br><img src="http://static.zybuluo.com/hushaofei/8fk7xz3e8t73n6xuzl8lif7w/generate.png" alt="generate.png-22.6kB"></p>
<p>Events和Listeners目录自动生成对应的文件：<br><img src="http://static.zybuluo.com/hushaofei/ij3kpq79xt18c29i5qhqzvjn/events.png" alt="events.png-16.6kB"><br><img src="http://static.zybuluo.com/hushaofei/gtdlcuy34rba40sqhqfi1t65/listeners.png" alt="listeners.png-19.3kB"></p>
<p>事件的属性应该存储尽可能多的数据（可以是对象，比如登录注册和充值，也可以是数组比如购买），适应更多的监听器业务。这个demo没有在zgapi项目做，需要参考的找我。记得测试或者使用队列事件的时候在项目根目录执行：<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup php artisan queue:listen &amp;</span><br></pre></td></tr></table></figure></p>
<p>启用队列的处理（消费）进程。</p>
<h3 id="队列中存放的数据结构"><a href="#队列中存放的数据结构" class="headerlink" title="队列中存放的数据结构"></a>队列中存放的数据结构</h3><p>mysql中jobs标的结构和数据如下<br><img src="http://static.zybuluo.com/hushaofei/gsn67p9ivlmd6b2j4fok1tz7/struct.png" alt="struct.png-91.8kB"><br>payload存的是序列化后的对象，如果是model只保存默认主键。</p>
<p>redis中会有一个key<code>queue:default</code>，暂时看不到数据，以后有兴趣的单独找。<br><img src="http://static.zybuluo.com/hushaofei/h3je0bpvp8edldo9f8yt28kl/redis.png" alt="redis.png-13.8kB"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/18/使用apidocjs维护api文档/" itemprop="url">
                  使用apidocjs维护api文档
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-05-18T18:02:01+08:00" content="2016-05-18">
              2016-05-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Nodejs及工具/" itemprop="url" rel="index">
                    <span itemprop="name">Nodejs及工具</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前使用markdown维护api文档,这种比较原始的方式缺点很明显:</p>
<blockquote>
<p>在单独的项目,更新步骤较多导致文档不同步<br>分组不明显<br>显示效果不尽如人意,不够友好(高大上)</p>
</blockquote>
<p>beego框架中astaxie引入swagger实现Rest风格的可视化文档,php同样也可以使用swagger来做,但是相对来说<br>apidocjs更方便使用一些.</p>
<h3 id="安装nodejs"><a href="#安装nodejs" class="headerlink" title="安装nodejs"></a>安装nodejs</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">brew install npm # osx</span><br><span class="line"></span><br><span class="line">sudo apt-get install curl # debian</span><br><span class="line">sudo curl -sL https://deb.nodesource.com/setup | bash -</span><br><span class="line">apt-get install -y nodejs</span><br></pre></td></tr></table></figure>
<h3 id="安装apidocjs"><a href="#安装apidocjs" class="headerlink" title="安装apidocjs"></a>安装apidocjs</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g apidoc</span><br></pre></td></tr></table></figure>
<h3 id="apidoc常用"><a href="#apidoc常用" class="headerlink" title="apidoc常用"></a>apidoc常用</h3><p><code>apidoc -i myapp/ -o apidoc/ -t mytemplate/</code><br>-i 指定输入目录, -o指定输出目录,-t为临时目录,示例shell文件如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">rm -rf doc/* # 多次执行会导致页面可能无法显示的问题</span><br><span class="line">rm -rf temp</span><br><span class="line">mkdir temp  # 临时目录</span><br><span class="line"></span><br><span class="line"># 遍历Controllers下面的文件,复制到temp临时目录</span><br><span class="line">for i in app/Http/Controllers ; do</span><br><span class="line">cp -r $i &quot;temp/$(dirname $(dirname $i))&quot;</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"># 使用apidoc工具生成html页面</span><br><span class="line">apidoc -i temp -o doc</span><br><span class="line">rm -r temp</span><br></pre></td></tr></table></figure></p>
<p><code>apidoc.json</code>示例配置文件如下:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"零钱购API文档 zgapi-ng"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"4.0.0"</span>,</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">"zerogo api next generation"</span>,</span><br><span class="line">  <span class="attr">"title"</span>: <span class="string">"zgapi-ng"</span>,</span><br><span class="line">  <span class="attr">"url"</span> : <span class="string">"http://testzgapi4.taojoy.com.cn"</span>,</span><br><span class="line">  <span class="attr">"order"</span>: [</span><br><span class="line"></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"header"</span>: &#123;</span><br><span class="line">    <span class="attr">"title"</span>: <span class="string">"接口说明"</span>,</span><br><span class="line">    <span class="attr">"filename"</span>: <span class="string">"header.md"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"footer"</span>: &#123;</span><br><span class="line">    <span class="attr">"title"</span>: <span class="string">"其它补充"</span>,</span><br><span class="line">    <span class="attr">"filename"</span>: <span class="string">"footer.md"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"template"</span>: &#123;</span><br><span class="line">    <span class="attr">"forceLanguage"</span>: <span class="string">"en"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>特别注意,<code>version</code>的值格式必须为<code>0.0.0</code>,不然会报错,包括控制器方法之前的注释也是一样.<br>示例代码注释:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> *</span><br><span class="line"> * @api &#123;put&#125; /v4/user/info 修改个人信息</span><br><span class="line"> * @apiName update</span><br><span class="line"> * @apiGroup User</span><br><span class="line"> *</span><br><span class="line"> * @apiDescription 修改个人信息</span><br><span class="line"> *</span><br><span class="line"> * @apiParam &#123;String&#125; nickname 用户昵称</span><br><span class="line"> * @apiParam &#123;String&#125; tel 手机号码</span><br><span class="line"> * @apiParam &#123;String&#125; email 邮箱</span><br><span class="line"> * @apiParam &#123;String&#125; signature 个性签名</span><br><span class="line"> * @apiParam &#123;String&#125; alipay 支付宝</span><br><span class="line"> * @apiParam &#123;String&#125; weixin 微信</span><br><span class="line"> * @apiParam &#123;String&#125; qq QQ号码</span><br><span class="line"> *</span><br><span class="line"> * @apiVersion 4.0.0</span><br><span class="line"> * @apiSuccessExample Success-Response:</span><br><span class="line"> *  HTTP/1.1 200 OK</span><br><span class="line"> * &#123;</span><br><span class="line"> *  &quot;code&quot;:200</span><br><span class="line"> *  &quot;detail&quot;:&quot;sucess&quot;</span><br><span class="line"> *  &quot;data&quot;:&#123; &#125;</span><br><span class="line"> *  &#125;</span><br><span class="line"> */</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/18/阿里云Debian7-5服务器更新php、redis和nginx等版本/" itemprop="url">
                  阿里云Debian7.5服务器更新php、redis和nginx等版本
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-05-18T17:29:01+08:00" content="2016-05-18">
              2016-05-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/OsX-Linux/" itemprop="url" rel="index">
                    <span itemprop="name">OsX & Linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>公司服务器系统版本使用Debian7.5,生产环境用的软件有php5-fpm,mysql,nginx,redis,nodejs等.<br>主要开发框架是Laravel5.1,要求php版本至少是5.5.9,默认源下载的php版本是5.4.x,nginx版本是1.2.1,redis版本也很低导致<br>无法bind多个ip.<br>已安装的环境需要升级,未安装的确保版本比较新,所以需要使用NB的dotdeb.org来作为源.</p>
<h3 id="修改-etc-apt-source-list文件"><a href="#修改-etc-apt-source-list文件" class="headerlink" title="修改/etc/apt/source.list文件"></a>修改/etc/apt/source.list文件</h3><p>在source.list末尾添加dotdeb的源信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deb http://packages.dotdeb.org wheezy all</span><br><span class="line">deb-src http://packages.dotdeb.org wheezy all</span><br><span class="line">deb http://packages.dotdeb.org wheezy-php56 all</span><br><span class="line">deb-src http://packages.dotdeb.org wheezy-php56 all</span><br></pre></td></tr></table></figure></p>
<h3 id="添加dotdeb的public-key"><a href="#添加dotdeb的public-key" class="headerlink" title="添加dotdeb的public key"></a>添加dotdeb的public key</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://www.dotdeb.org/dotdeb.gpg</span><br><span class="line">cat dotdeb.gpg | apt-key add -</span><br></pre></td></tr></table></figure>
<p>更新源并安装php5-cli<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ apt-get update</span><br><span class="line">$ apt-get install php5-cli</span><br><span class="line">$ php -v</span><br><span class="line">PHP 5.6.21-1~dotdeb+7.1 (cli) (built: Apr 29 2016 13:07:22)</span><br><span class="line">Copyright (c) 1997-2016 The PHP Group</span><br><span class="line">Zend Engine v2.6.0, Copyright (c) 1998-2016 Zend Technologies</span><br><span class="line">    with Zend OPcache v7.0.6-dev, Copyright (c) 1999-2016, by Zend Technologies</span><br></pre></td></tr></table></figure></p>
<p>更新之后安装的php,nginx和redis都是比较新的版本.</p>
<h3 id="升级php5-4到5-6"><a href="#升级php5-4到5-6" class="headerlink" title="升级php5.4到5.6"></a>升级php5.4到5.6</h3><p>上述步骤执行完之后,执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get upgrade # 升级</span><br><span class="line">apt-get dist-upgrade # 有依赖版本不统一的情况下一起升级</span><br></pre></td></tr></table></figure></p>
<p><code>The packages from Dotdeb should work on Ubuntu, but no additional support will be provided.</code><br>官方说dotdeb的软件包可以在Ubuntu运行,只是不提供额外的技术支持,所以Ubuntu也可以使用.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/18/阿里云服务器laravel获取不到客户端真实ip的问题/" itemprop="url">
                  阿里云服务器laravel获取不到客户端真实ip的问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-05-18T15:19:04+08:00" content="2016-05-18">
              2016-05-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Laravel/" itemprop="url" rel="index">
                    <span itemprop="name">Laravel</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>一般情况下在laravel5.1使用下面的方式可以正确的获取客户端ip:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ip = request()-&gt;getClientIp();</span><br></pre></td></tr></table></figure></p>
<p>服务器使用阿里云的SLB做了负载均衡之后,使用这种方式获取的ip明显是代理ip,查看源码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getClientIp</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $ipAddresses = <span class="keyword">$this</span>-&gt;getClientIps();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $ipAddresses[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续查看<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getClientIps</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    $clientIps = <span class="keyword">array</span>();</span><br><span class="line">    $ip = <span class="keyword">$this</span>-&gt;server-&gt;get(<span class="string">'REMOTE_ADDR'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;isFromTrustedProxy()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>($ip);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>这段代码就可以看出问题所在了,使用SLB之后REMOTE_ADDR是代理地址,HTTP_X_FORWARD_FOR才是真实的<br>客户端ip,说明<code>$this-&gt;isFromTrustedProxy()</code>返回false.查看其代码<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">isFromTrustedProxy</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>::$trustedProxies &amp;&amp; IpUtils::checkIp(<span class="keyword">$this</span>-&gt;server-&gt;get(<span class="string">'REMOTE_ADDR'</span>), <span class="keyword">self</span>::$trustedProxies);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>说明默认为空数组的<code>$trustedProxies</code>需要手动设置,并且REMOTE_ADDR在设置的代理地址里面才返回true.如果使用<br><code>setTrustedProxies(array $proxies)</code>才可以.蛋疼的是nginx日志显示REMOTE_ADDR也就是代理地址一直在改变,所以<br>手动设置代理地址不可能了,那就用原始的方法获取,从HTTP_X_FORWARD_FOR获取.<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getIp</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="comment">//return request()-&gt;getClientIp();</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>]) &amp;&amp; preg_match(<span class="string">'/^([0-9]&#123;1,3&#125;\.)&#123;3&#125;[0-9]&#123;1,3&#125;$/'</span>,$_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>])) &#123;</span><br><span class="line">    $clientip = $_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>];</span><br><span class="line">  &#125; <span class="keyword">elseif</span>  (<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_CLIENT_IP'</span>])  &amp;&amp; preg_match(<span class="string">'/^([0-9]&#123;1,3&#125;\.)&#123;3&#125;[0-9]&#123;1,3&#125;$/'</span>,$_SERVER[<span class="string">'HTTP_CLIENT_IP'</span>])) &#123;</span><br><span class="line">    $clientip = $_SERVER[<span class="string">'HTTP_CLIENT_IP'</span>];</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> $_SERVER[<span class="string">'REMOTE_ADDR'</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  $ip = explode(<span class="string">','</span>,$clientip)[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">return</span> $ip;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这种方式会从HTTP_X_FORWARD_FOR获取正确的client ip.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/13/composer包开发示例/" itemprop="url">
                  composer包开发示例
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-05-13T18:33:48+08:00" content="2016-05-13">
              2016-05-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Tools/" itemprop="url" rel="index">
                    <span itemprop="name">Tools</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="关于composer"><a href="#关于composer" class="headerlink" title="关于composer"></a>关于composer</h2><blockquote>
<p>composer的作用类似于node.js的npm,用来代替PEAR以更简单简洁的方式安装php项目的依赖包.composer和git以及packagelist<br>密切相关.代码本身通常托管在github的仓库,在packagelist发布自己的包,url是github的仓库地址.</p>
</blockquote>
<h2 id="composer包开发流程"><a href="#composer包开发流程" class="headerlink" title="composer包开发流程"></a>composer包开发流程</h2><h3 id="在github新建仓库-本地克隆"><a href="#在github新建仓库-本地克隆" class="headerlink" title="在github新建仓库,本地克隆"></a>在github新建仓库,本地克隆</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone git@github.com:faquiir/package-test.git</span><br><span class="line">cd package-test</span><br><span class="line">composer init</span><br></pre></td></tr></table></figure>
<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p>执行<code>compsoer init</code>之后会出现交互的提示,按照提示输入包名,作者,描述,依赖的包和开源协议等信息,然后会自动生成<code>composer.json</code><br>文件.<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"huy/test"</span>,</span><br><span class="line">    <span class="attr">"description"</span>: <span class="string">"composer and package.list test."</span>,</span><br><span class="line">    <span class="attr">"require"</span>: &#123;</span><br><span class="line">        <span class="attr">"php"</span>: <span class="string">"&gt;=5.3"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"license"</span>: <span class="string">"MIT"</span>,</span><br><span class="line">    <span class="attr">"authors"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"hushaofei"</span>,</span><br><span class="line">            <span class="attr">"email"</span>: <span class="string">"858518145@qq.com"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"minimum-stability"</span>: <span class="string">"stable"</span>,</span><br><span class="line">    <span class="attr">"autoload"</span>: &#123;</span><br><span class="line">        <span class="attr">"psr-4"</span>: &#123;</span><br><span class="line">            <span class="attr">"Huy\\"</span>: <span class="string">"src/"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>修改生成的<code>composer.json</code>文件,增加autoload配置,Huy命名空间的根目录是当前目录下的src/.</p>
<h3 id="根据配置文件生成包骨架"><a href="#根据配置文件生成包骨架" class="headerlink" title="根据配置文件生成包骨架"></a>根据配置文件生成包骨架</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer install</span><br></pre></td></tr></table></figure>
<p>执行完目录下会生成<code>vendor</code>目录,当前目录结构如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── README.md</span><br><span class="line">├── composer.json</span><br><span class="line">├── composer.lock</span><br><span class="line">├── src</span><br><span class="line">│   └── Test.php</span><br><span class="line">├── test.php</span><br><span class="line">└── vendor</span><br><span class="line">    ├── autoload.php</span><br><span class="line">    └── composer</span><br><span class="line">        ├── ClassLoader.php</span><br><span class="line">        ├── LICENSE</span><br><span class="line">        ├── autoload_classmap.php</span><br><span class="line">        ├── autoload_namespaces.php</span><br><span class="line">        ├── autoload_psr4.php</span><br><span class="line">        ├── autoload_real.php</span><br><span class="line">        └── installed.json</span><br></pre></td></tr></table></figure></p>
<p>打开<code>autoload_psr4.php</code>文件,可见<code>composer.json</code>文件配置的命名空间和目录的映射已经生成.<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// autoload_psr4.php @generated by Composer</span></span><br><span class="line"></span><br><span class="line">$vendorDir = dirname(dirname(<span class="keyword">__FILE__</span>));</span><br><span class="line">$baseDir = dirname($vendorDir);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'Huy\\'</span> =&gt; <span class="keyword">array</span>($baseDir . <span class="string">'/src'</span>),</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<h3 id="创建目录和测试文件"><a href="#创建目录和测试文件" class="headerlink" title="创建目录和测试文件"></a>创建目录和测试文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir src &amp;&amp; cd  src</span><br><span class="line">touch Test.php</span><br></pre></td></tr></table></figure>
<p>Test.php内容如下:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Huy</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayHi</span><span class="params">()</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"hi~"</span> . PHP_EOL;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在根目录新建<code>test.php</code>内容如下:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line">$test = <span class="keyword">new</span> Huy\Test();</span><br><span class="line">$test-&gt;sayHi();</span><br></pre></td></tr></table></figure></p>
<p>然后执行<code>php test.php</code>可以正常输出.</p>
<h3 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h3><p>如果composer.json中 <code>&quot;minimum-stability&quot;: &quot;stable&quot;</code> 配置的是dev,可以先修改为stable然后执行<br><code>composer update</code>进行更新,这个配置别人使用包的时候会用到,如果是开发测试完成就可以修改为stable.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git commit -am &quot;状态修改&quot;</span><br><span class="line">git push origin master</span><br></pre></td></tr></table></figure>
<p>在<code>https://packagist.org/</code>注册登录然后submit自己的github仓库地址即可.</p>
<p>然后是在新的项目安装测试这个包:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ../demos</span><br><span class="line">composer require huy/test dev-master # 在github未release该项目时需要加上dev-master</span><br></pre></td></tr></table></figure></p>
<p>剩下的就是和使用别的包一样了:<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Huy</span>\<span class="title">Test</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Event</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span><br><span class="line"></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span><br><span class="line">  </span>&#123;</span><br><span class="line">    $test = <span class="keyword">new</span> Test();</span><br><span class="line">    $test-&gt;sayHi();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样一个简单的composer包就开发完成了.</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/12/Hexo搭建个人wiki/" itemprop="url">
                  Hexo搭建个人wiki
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-05-12T16:18:28+08:00" content="2016-05-12">
              2016-05-12
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Nodejs及工具/" itemprop="url" rel="index">
                    <span itemprop="name">Nodejs及工具</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="创建github项目"><a href="#创建github项目" class="headerlink" title="创建github项目"></a>创建github项目</h2><p>github pages要求项目名称为username.github.io，新建faquiir.github.io。</p>
<h2 id="安装Hexo和wixo主题"><a href="#安装Hexo和wixo主题" class="headerlink" title="安装Hexo和wixo主题"></a>安装Hexo和wixo主题</h2><h3 id="安装npm"><a href="#安装npm" class="headerlink" title="安装npm"></a>安装npm</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install npm</span><br></pre></td></tr></table></figure>
<h3 id="安装Hexo"><a href="#安装Hexo" class="headerlink" title="安装Hexo"></a>安装Hexo</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g hexo-cli</span><br></pre></td></tr></table></figure>
<h3 id="自动部署需要安装git"><a href="#自动部署需要安装git" class="headerlink" title="自动部署需要安装git"></a>自动部署需要安装git</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install git</span><br></pre></td></tr></table></figure>
<h3 id="安装hexo的git插件"><a href="#安装hexo的git插件" class="headerlink" title="安装hexo的git插件"></a>安装hexo的git插件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure>
<h3 id="安装wixo主题"><a href="#安装wixo主题" class="headerlink" title="安装wixo主题"></a>安装wixo主题</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/wzpan/hexo-theme-wixo.git themes/wixo</span><br><span class="line">npm install hexo-tag-bootstrap --save</span><br></pre></td></tr></table></figure>
<p>修改_config.yml，<code>theme</code>修改为<code>wixo</code>，<code>deploy</code>修改为</p>
<blockquote>
<p>deploy:<br>  type: git<br>  repo: <a href="https://github.com/faquiiR/faquiir.github.io" target="_blank" rel="external">https://github.com/faquiiR/faquiir.github.io</a><br>  branch: master </p>
</blockquote>
<h3 id="配置github的CNAME"><a href="#配置github的CNAME" class="headerlink" title="配置github的CNAME"></a>配置github的CNAME</h3><p>hexo上传CNAME文件需要放在source目录</p>
<h3 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h3><blockquote>
<p>hexo new hello-world (wixo目录根据categories标签的值区分)<br>hexo clean<br>hexo deploy -g 或者hexo generate -d 生成静态文件并部署到github<br>hexo server (在<a href="http://localhost:4000端口预览" target="_blank" rel="external">http://localhost:4000端口预览</a>)</p>
</blockquote>
<h3 id="使用hexo的坑"><a href="#使用hexo的坑" class="headerlink" title="使用hexo的坑"></a>使用hexo的坑</h3><p>换了个电脑，又没有备份之前的markdown文件，重新搭hexo之后本地文件覆盖github的，导致之前的文件全没了，只能从本地的md再重新整理了。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Huy" />
          <p class="site-author-name" itemprop="name">Huy</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">10</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Huy</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  



  




  
  

  

  

  

  


</body>
</html>
